<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Buber Health">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23a8e6cf'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white'>üí™</text></svg>">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23a8e6cf'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white'>üí™</text></svg>">
    <title>Buber Health</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            overscroll-behavior: none;
            background: linear-gradient(135deg, #fef3e2 0%, #fce8f3 100%);
        }

        /* Custom pastel color palette */
        :root {
            --mint: #b8f4d4;
            --peach: #ffd4b8;
            --coral: #ffb8b8;
            --soft-blue: #d4e4ff;
            --soft-purple: #e8d4ff;
            --soft-yellow: #fff4b8;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            padding: 8px;
            font-size: 12px;
            border: none;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }
        .calendar-day:active {
            transform: scale(0.95);
        }

        /* Card styles */
        .card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        /* Button styles */
        .btn-primary {
            background: linear-gradient(135deg, #a8e6cf 0%, #7fd4b8 100%);
            border: none;
            border-radius: 16px;
            padding: 1rem 1.5rem;
            font-weight: 600;
            color: #2d3748;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(168, 230, 207, 0.3);
        }
        .btn-primary:active {
            transform: scale(0.98);
        }

        /* Input styles */
        input[type="number"] {
            -webkit-appearance: none;
            appearance: none;
            border-radius: 12px;
            border: 2px solid #e8e8e8;
            transition: all 0.2s ease;
        }
        input[type="number"]:focus {
            outline: none;
            border-color: #a8e6cf;
            box-shadow: 0 0 0 4px rgba(168, 230, 207, 0.1);
        }

        /* Workout buttons */
        .workout-btn {
            border-radius: 16px;
            transition: all 0.2s ease;
            border: 2px solid #e8e8e8;
        }
        .workout-btn.active-yes {
            background: linear-gradient(135deg, #b8f4d4 0%, #a8e6cf 100%);
            border-color: #7fd4b8;
            box-shadow: 0 4px 12px rgba(184, 244, 212, 0.4);
        }
        .workout-btn.active-no {
            background: linear-gradient(135deg, #ffb8b8 0%, #ffa8a8 100%);
            border-color: #ff9898;
            box-shadow: 0 4px 12px rgba(255, 184, 184, 0.4);
        }

        /* Fade in animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* Confetti animation */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f0f;
            position: fixed;
            top: -10px;
            z-index: 9999;
            animation: confetti-fall 3s linear;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Badge styles */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
            animation: badgePop 0.5s ease;
        }

        @keyframes badgePop {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Tooltip for week view */
        .day-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            pointer-events: none;
            z-index: 1000;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .day-tooltip.show {
            opacity: 1;
        }
        .calendar-day-header {
            font-weight: 600;
            padding: 8px 4px;
            text-align: center;
            font-size: 12px;
        }
        .emoji-indicator {
            font-size: 14px;
            margin: 2px;
        }
        /* Better portrait mode support */
        .calendar-day {
            min-height: 60px;
        }
        @media (min-width: 640px) {
            .calendar-day {
                font-size: 14px;
                min-height: 80px;
            }
            .emoji-indicator {
                font-size: 20px;
            }
        }
        @media (orientation: landscape) and (max-width: 900px) {
            .calendar-day {
                min-height: 50px;
                font-size: 10px;
            }
            .emoji-indicator {
                font-size: 14px;
            }
        }
        input[type="number"] {
            -webkit-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        // Simple state management
        class HealthTracker {
            constructor() {
                this.state = {
                    view: 'daily',
                    entries: {},
                    currentDate: new Date(),
                    selectedDate: null,
                    editEntry: { alcohol: '', steps: '', workout: null }
                };
                this.listeners = [];
                this.loadData();
            }

            loadData() {
                try {
                    const saved = localStorage.getItem('healthTrackerData');
                    if (saved) {
                        this.state.entries = JSON.parse(saved);
                    }
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            }

            saveData() {
                try {
                    localStorage.setItem('healthTrackerData', JSON.stringify(this.state.entries));
                } catch (e) {
                    console.error('Error saving data:', e);
                }
            }

            setState(updates, skipRender = false) {
                this.state = { ...this.state, ...updates };
                if (!skipRender) {
                    this.listeners.forEach(fn => fn(this.state));
                }
            }

            subscribe(fn) {
                this.listeners.push(fn);
                return () => {
                    this.listeners = this.listeners.filter(l => l !== fn);
                };
            }

            formatDate(date) {
                const d = new Date(date);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            getColor(type, value) {
                if (value === null || value === undefined || value === '') return 'bg-gray-200';

                switch(type) {
                    case 'alcohol':
                        const drinks = parseInt(value);
                        if (isNaN(drinks)) return 'bg-gray-200';
                        if (drinks >= 0 && drinks <= 2) return 'bg-[#b8f4d4]'; // Mint
                        if (drinks >= 3 && drinks <= 4) return 'bg-[#fff4b8]'; // Soft yellow
                        if (drinks >= 5) return 'bg-[#ffb8b8]'; // Coral
                        return 'bg-gray-200';
                    case 'steps':
                        const steps = parseInt(value);
                        if (isNaN(steps)) return 'bg-gray-200';
                        return steps >= 12500 ? 'bg-[#b8f4d4]' : 'bg-[#ffb8b8]'; // Mint or Coral
                    case 'workout':
                        // Check if value is explicitly false (not just falsy)
                        if (value === false) return 'bg-[#ffb8b8]'; // Coral for No
                        if (value === true) return 'bg-[#b8f4d4]'; // Mint for Yes
                        return 'bg-gray-200'; // Gray for not selected yet
                    default:
                        return 'bg-gray-200';
                }
            }

            saveEntry(date) {
                const dateKey = this.formatDate(date);
                const entry = {
                    alcohol: this.state.editEntry.alcohol,
                    steps: this.state.editEntry.steps,
                    workout: this.state.editEntry.workout
                };

                this.state.entries[dateKey] = entry;
                this.saveData();

                // Check for perfect day and celebrate!
                const isPerfectDay = this.isPerfectDay(entry);
                if (isPerfectDay) {
                    this.celebrate();
                }

                // Check for milestones
                const milestone = this.checkMilestones();

                this.setState({
                    entries: this.state.entries,
                    view: 'daily',
                    selectedDate: null,
                    milestone: milestone
                });
            }

            isPerfectDay(entry) {
                const drinks = parseInt(entry.alcohol);
                const steps = parseInt(entry.steps);
                return (drinks >= 0 && drinks <= 2) && steps >= 12500 && entry.workout;
            }

            celebrate() {
                // Create confetti
                const colors = ['#b8f4d4', '#ffd4b8', '#ffb8b8', '#d4e4ff', '#fff4b8'];
                for (let i = 0; i < 50; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = Math.random() * 100 + '%';
                        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.animationDelay = Math.random() * 0.5 + 's';
                        document.body.appendChild(confetti);
                        setTimeout(() => confetti.remove(), 3000);
                    }, i * 30);
                }
            }

            checkMilestones() {
                const dates = Object.keys(this.state.entries).sort();

                // Count perfect days
                let perfectDays = 0;
                dates.forEach(date => {
                    if (this.isPerfectDay(this.state.entries[date])) {
                        perfectDays++;
                    }
                });

                // Count workout streak
                let streak = 0;
                let checkDate = new Date();
                while (this.state.entries[this.formatDate(checkDate)]?.workout) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                }

                // Return milestone if achieved
                if (perfectDays === 1) return { icon: 'üåü', text: 'First Perfect Day!' };
                if (perfectDays === 7) return { icon: '‚ú®', text: '7 Perfect Days!' };
                if (perfectDays === 30) return { icon: 'üèÜ', text: '30 Perfect Days!' };
                if (streak === 3) return { icon: 'üî•', text: '3-Day Workout Streak!' };
                if (streak === 7) return { icon: 'üí™', text: 'Week-Long Streak!' };
                if (streak === 30) return { icon: 'üëë', text: 'Monthly Streak Champion!' };

                return null;
            }

            deleteEntry(dateKey) {
                if (confirm('Are you sure you want to delete this entry?')) {
                    delete this.state.entries[dateKey];
                    this.saveData();
                    this.setState({ entries: this.state.entries });
                }
            }

            editDate(date) {
                const dateKey = this.formatDate(date);
                const entry = this.state.entries[dateKey];
                this.setState({
                    selectedDate: date,
                    editEntry: entry ? { ...entry } : { alcohol: '', steps: '', workout: null },
                    view: 'edit'
                });
            }

            updateEntry(field, value) {
                // Validate and constrain values
                if (field === 'alcohol') {
                    const alcoholValue = parseInt(value);
                    if (!isNaN(alcoholValue)) {
                        if (alcoholValue < 0) value = '0';
                        if (alcoholValue > 50) value = '50';
                    }
                } else if (field === 'steps') {
                    const stepsValue = parseInt(value);
                    if (!isNaN(stepsValue)) {
                        if (stepsValue < 0) value = '0';
                        if (stepsValue > 100000) value = '100000';
                    }
                }

                this.state.editEntry[field] = value;
                // Don't update backgrounds during typing - only update on blur or workout toggle
            }

            updateColorBackgrounds() {
                // Update background colors based on current values without re-rendering
                const alcoholBg = document.querySelector('[data-bg="alcohol"]');
                const stepsBg = document.querySelector('[data-bg="steps"]');
                const workoutBg = document.querySelector('[data-bg="workout"]');

                if (alcoholBg) {
                    alcoholBg.className = `card ${this.getColor('alcohol', this.state.editEntry.alcohol)}`;
                    alcoholBg.style.transition = 'all 0.3s ease';
                }
                if (stepsBg) {
                    stepsBg.className = `card ${this.getColor('steps', this.state.editEntry.steps)}`;
                    stepsBg.style.transition = 'all 0.3s ease';
                }
                if (workoutBg) {
                    workoutBg.className = `card ${this.getColor('workout', this.state.editEntry.workout)}`;
                    workoutBg.style.transition = 'all 0.3s ease';
                }
            }

            changeView(view) {
                if (view === 'daily') {
                    const today = new Date();
                    const todayKey = this.formatDate(today);
                    const entry = this.state.entries[todayKey];
                    this.setState({
                        view,
                        selectedDate: today,
                        editEntry: entry ? { ...entry } : { alcohol: '', steps: '', workout: false }
                    });
                } else {
                    this.setState({ view });
                }
            }

            exportData() {
                const dataStr = JSON.stringify(this.state.entries, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `health-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                alert('‚úÖ Data exported! Save this file somewhere safe.');
            }

            importData(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        // Merge with existing data (imported data takes precedence)
                        this.state.entries = { ...this.state.entries, ...importedData };
                        this.saveData();
                        this.setState({ entries: this.state.entries });
                        alert('‚úÖ Data imported successfully!');
                    } catch (error) {
                        alert('‚ùå Error importing data. Please check the file.');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            }
        }

        const tracker = new HealthTracker();

        function App() {
            const container = document.getElementById('root');

            function render() {
                const state = tracker.state;

                container.innerHTML = `
                    <div class="max-w-4xl mx-auto min-h-screen">
                        <div class="bg-gradient-to-r from-[#a8e6cf] to-[#7fd4b8] text-white p-6 shadow-lg" style="border-radius: 0 0 30px 30px;">
                            <h1 class="text-3xl font-bold text-center tracking-tight" style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">Buber Health</h1>
                        </div>

                        <div class="bg-white shadow-lg sticky top-0 z-10" style="border-radius: 0 0 20px 20px;">
                            <div class="flex gap-1 p-2">
                                <button data-view="daily" class="flex-1 py-3 font-semibold rounded-xl transition-all ${state.view === 'daily' ? 'bg-gradient-to-r from-[#a8e6cf] to-[#7fd4b8] text-white shadow-lg' : 'bg-transparent text-gray-600 hover:bg-gray-50'}">
                                    Daily
                                </button>
                                <button data-view="weekly" class="flex-1 py-3 font-semibold rounded-xl transition-all ${state.view === 'weekly' ? 'bg-gradient-to-r from-[#a8e6cf] to-[#7fd4b8] text-white shadow-lg' : 'bg-transparent text-gray-600 hover:bg-gray-50'}">
                                    Weekly
                                </button>
                                <button data-view="monthly" class="flex-1 py-3 font-semibold rounded-xl transition-all ${state.view === 'monthly' ? 'bg-gradient-to-r from-[#a8e6cf] to-[#7fd4b8] text-white shadow-lg' : 'bg-transparent text-gray-600 hover:bg-gray-50'}">
                                    Monthly
                                </button>
                                <button data-view="summary" class="flex-1 py-3 font-semibold rounded-xl transition-all ${state.view === 'summary' ? 'bg-gradient-to-r from-[#a8e6cf] to-[#7fd4b8] text-white shadow-lg' : 'bg-transparent text-gray-600 hover:bg-gray-50'}">
                                    Summary
                                </button>
                            </div>
                        </div>

                        <div class="pb-6" id="content">
                            ${renderView(state)}
                        </div>
                    </div>
                `;

                attachEventListeners();
            }

            function renderView(state) {
                switch(state.view) {
                    case 'daily':
                    case 'edit':
                        return renderEditView(state);
                    case 'weekly':
                        return renderWeeklyView(state);
                    case 'monthly':
                        return renderMonthlyView(state);
                    case 'summary':
                        return renderSummaryView(state);
                    default:
                        return '';
                }
            }

            function renderEditView(state) {
                const date = state.view === 'edit' ? state.selectedDate : new Date();
                const entry = state.editEntry;
                const isEdit = state.view === 'edit';
                const dateStr = new Date(date).toLocaleDateString('en-US', {
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                });

                // Get encouraging message
                const todayKey = tracker.formatDate(new Date());
                const todayEntry = state.entries[todayKey];
                let encouragement = '';

                if (todayEntry) {
                    const isPerfect = tracker.isPerfectDay(todayEntry);
                    if (isPerfect) {
                        encouragement = '<div class="card bg-gradient-to-r from-[#b8f4d4] to-[#a8e6cf] mb-4"><p class="text-center font-semibold text-gray-800">üéâ Perfect day! You\'re crushing it!</p></div>';
                    }
                }

                // Show milestone badge if exists
                const milestoneHtml = state.milestone ? `
                    <div class="badge mx-auto mb-4">
                        <span class="text-2xl">${state.milestone.icon}</span>
                        <span>${state.milestone.text}</span>
                    </div>
                ` : '';

                return `
                    <div class="p-4 space-y-6 fade-in">
                        ${milestoneHtml}
                        ${isEdit ? `
                            <div class="flex items-center justify-between mb-6">
                                <button data-action="back" class="text-[#7fd4b8] font-semibold text-lg hover:text-[#6fc4a8] transition-colors">‚Üê Back</button>
                                <h2 class="text-xl font-bold text-gray-800">${dateStr}</h2>
                                <button data-action="delete-entry" data-date="${dateKey}" class="text-red-500 font-semibold text-lg hover:text-red-600 transition-colors">üóëÔ∏è</button>
                            </div>
                        ` : `
                            <h2 class="text-3xl font-bold text-center mb-6 text-gray-800" style="text-shadow: 0 2px 4px rgba(0,0,0,0.05);">Today's Entry</h2>
                            ${encouragement}
                        `}

                        <div data-bg="alcohol" class="card ${tracker.getColor('alcohol', entry.alcohol)}" style="transition: all 0.3s ease;">
                            <div class="flex items-center mb-3">
                                <span class="text-4xl mr-3">üç∑</span>
                                <label class="text-xl font-bold text-gray-800">Grey Juice</label>
                            </div>
                            <input
                                type="number"
                                inputmode="numeric"
                                min="0"
                                max="50"
                                data-field="alcohol"
                                value="${entry.alcohol}"
                                class="w-full p-4 text-xl font-semibold text-gray-800"
                                placeholder="0"
                            />
                            <p class="mt-3 text-sm text-gray-600">‚ú® Mint: 0-2 | ‚òÄÔ∏è Yellow: 3-4 | üå∏ Coral: 5+</p>
                        </div>

                        <div data-bg="steps" class="card ${tracker.getColor('steps', entry.steps)}" style="transition: all 0.3s ease;">
                            <div class="flex items-center mb-3">
                                <span class="text-4xl mr-3">üëü</span>
                                <label class="text-xl font-bold text-gray-800">Steps</label>
                            </div>
                            <input
                                type="number"
                                inputmode="numeric"
                                min="0"
                                max="100000"
                                data-field="steps"
                                value="${entry.steps}"
                                class="w-full p-4 text-xl font-semibold text-gray-800"
                                placeholder="0"
                            />
                            <p class="mt-3 text-sm text-gray-600">‚ú® Mint: 12,500+ | üå∏ Coral: Less than 12,500</p>
                        </div>

                        <div data-bg="workout" class="card ${tracker.getColor('workout', entry.workout)}" style="transition: all 0.3s ease;">
                            <div class="flex items-center mb-3">
                                <span class="text-4xl mr-3">üí™</span>
                                <label class="text-xl font-bold text-gray-800">Workout</label>
                            </div>
                            <div class="flex gap-4">
                                <button
                                    data-workout="true"
                                    class="workout-btn flex-1 p-4 text-lg font-semibold ${
                                        entry.workout
                                            ? 'active-yes text-gray-800'
                                            : 'bg-white text-gray-600'
                                    }"
                                >
                                    Yes ‚úì
                                </button>
                                <button
                                    data-workout="false"
                                    class="workout-btn flex-1 p-4 text-lg font-semibold ${
                                        !entry.workout
                                            ? 'active-no text-gray-800'
                                            : 'bg-white text-gray-600'
                                    }"
                                >
                                    No ‚úó
                                </button>
                            </div>
                            <p class="mt-3 text-sm text-gray-600">‚ú® Mint: Yes | üå∏ Coral: No</p>
                        </div>

                        <button
                            data-action="save"
                            class="btn-primary w-full text-xl"
                        >
                            üíæ Save Entry
                        </button>
                    </div>
                `;
            }

            function renderWeeklyView(state) {
                const startOfWeek = new Date(state.currentDate);
                startOfWeek.setDate(state.currentDate.getDate() - state.currentDate.getDay());

                const days = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    days.push(date);
                }

                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const todayKey = tracker.formatDate(new Date());

                return `
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-4">
                            <button data-action="prev-week" class="bg-gradient-to-r from-[#a8e6cf] to-[#7fd4b8] text-white px-6 py-2 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all">
                                ‚Üê Prev
                            </button>
                            <h2 class="text-xl font-bold">
                                ${startOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} -
                                ${days[6].toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                            </h2>
                            <button data-action="next-week" class="bg-gradient-to-r from-[#a8e6cf] to-[#7fd4b8] text-white px-6 py-2 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all">
                                Next ‚Üí
                            </button>
                        </div>

                        <div class="calendar-grid" style="position: relative;">
                            ${days.map((date, idx) => {
                                const dateKey = tracker.formatDate(date);
                                const entry = state.entries[dateKey];
                                const isToday = dateKey === todayKey;
                                const tooltipData = entry ? `üç∑ ${entry.alcohol} | üëü ${parseInt(entry.steps).toLocaleString()} | üí™ ${entry.workout ? 'Yes' : 'No'}` : 'No data';

                                return `
                                    <div class="flex flex-col">
                                        <div class="calendar-day-header">${dayNames[idx]}</div>
                                        <button
                                            data-edit-date="${dateKey}"
                                            data-tooltip="${tooltipData}"
                                            class="calendar-day bg-gray-100 hover:bg-gray-200 cursor-pointer ${isToday ? 'ring-2 ring-[#7fd4b8]' : ''}"
                                            style="position: relative;"
                                        >
                                            <div class="font-semibold mb-1">${date.getDate()}</div>
                                            ${entry ? `
                                                <div class="flex flex-wrap gap-1 justify-center" style="max-width: 100%;">
                                                    <div class="emoji-indicator ${tracker.getColor('alcohol', entry.alcohol)} rounded px-1" style="flex-shrink: 0;">üç∑</div>
                                                    <div class="emoji-indicator ${tracker.getColor('steps', entry.steps)} rounded px-1" style="flex-shrink: 0;">üëü</div>
                                                    <div class="emoji-indicator ${tracker.getColor('workout', entry.workout)} rounded px-1" style="flex-shrink: 0;">üí™</div>
                                                </div>
                                            ` : '<div class="text-gray-400 text-xs mt-1">Tap to add</div>'}
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                            <div id="tooltip" class="day-tooltip"></div>
                        </div>
                    </div>
                `;
            }

            function renderMonthlyView(state) {
                const year = state.currentDate.getFullYear();
                const month = state.currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDay = firstDay.getDay();
                const daysInMonth = lastDay.getDate();

                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const monthName = state.currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                const todayKey = tracker.formatDate(new Date());

                const weeks = [];
                let week = new Array(startDay).fill(null);

                for (let day = 1; day <= daysInMonth; day++) {
                    if (week.length === 7) {
                        weeks.push(week);
                        week = [];
                    }
                    week.push(day);
                }

                if (week.length > 0) {
                    while (week.length < 7) {
                        week.push(null);
                    }
                    weeks.push(week);
                }

                return `
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-4">
                            <button data-action="prev-month" class="bg-gradient-to-r from-[#a8e6cf] to-[#7fd4b8] text-white px-6 py-2 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all">
                                ‚Üê Prev
                            </button>
                            <h2 class="text-xl font-bold">${monthName}</h2>
                            <button data-action="next-month" class="bg-gradient-to-r from-[#a8e6cf] to-[#7fd4b8] text-white px-6 py-2 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all">
                                Next ‚Üí
                            </button>
                        </div>

                        <div class="calendar-grid mb-2">
                            ${dayNames.map(name => `<div class="calendar-day-header">${name}</div>`).join('')}
                        </div>

                        ${weeks.map(week => `
                            <div class="calendar-grid mb-1">
                                ${week.map(day => {
                                    if (!day) return '<div class="calendar-day"></div>';

                                    const date = new Date(year, month, day);
                                    const dateKey = tracker.formatDate(date);
                                    const entry = state.entries[dateKey];
                                    const isToday = dateKey === todayKey;

                                    return `
                                        <button
                                            data-edit-date="${dateKey}"
                                            class="calendar-day bg-gray-100 hover:bg-gray-200 cursor-pointer ${isToday ? 'ring-2 ring-[#7fd4b8]' : ''}"
                                        >
                                            <div class="font-semibold">${day}</div>
                                            ${entry ? `
                                                <div class="flex gap-1 mt-1">
                                                    <span class="text-xs ${tracker.getColor('alcohol', entry.alcohol)} rounded px-1">üç∑</span>
                                                    <span class="text-xs ${tracker.getColor('steps', entry.steps)} rounded px-1">üëü</span>
                                                    <span class="text-xs ${tracker.getColor('workout', entry.workout)} rounded px-1">üí™</span>
                                                </div>
                                            ` : '<div class="text-gray-400 text-xs mt-1">-</div>'}
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            function renderSummaryView(state) {
                const allDates = Object.keys(state.entries).sort().reverse();

                // Get current year entries
                const currentYear = new Date().getFullYear();
                const yearDates = allDates.filter(date => {
                    const entryDate = new Date(date);
                    const entryYear = entryDate.getFullYear();

                    // For 2026, only include dates from January 18 onwards
                    if (entryYear === 2026) {
                        const cutoffDate = new Date('2026-01-18');
                        return entryDate >= cutoffDate;
                    }

                    // For all other years, include full year
                    return entryYear === currentYear;
                });

                let alcoholGreen = 0, alcoholYellow = 0, alcoholRed = 0;
                let stepsGreen = 0, stepsRed = 0;
                let workoutYes = 0, workoutNo = 0;
                let allThreeGoals = 0;

                // Group dates by week for workout calculation
                const weeklyWorkouts = {};
                const weeklyAlcohol = {};
                const weeklySteps = {};

                yearDates.forEach(date => {
                    const entry = state.entries[date];
                    const entryDate = new Date(date);

                    // Get week key (year + week number)
                    const weekStart = new Date(entryDate);
                    weekStart.setDate(entryDate.getDate() - entryDate.getDay()); // Start of week (Sunday)
                    const weekKey = tracker.formatDate(weekStart);

                    // Initialize week tracking
                    if (!weeklyWorkouts[weekKey]) {
                        weeklyWorkouts[weekKey] = 0;
                        weeklyAlcohol[weekKey] = [];
                        weeklySteps[weekKey] = [];
                    }

                    // Track daily metrics
                    const drinks = parseInt(entry.alcohol);
                    const alcoholSuccess = drinks >= 0 && drinks <= 2;
                    if (alcoholSuccess) alcoholGreen++;
                    else if (drinks >= 3 && drinks <= 4) alcoholYellow++;
                    else if (drinks >= 5) alcoholRed++;

                    const steps = parseInt(entry.steps);
                    const stepsSuccess = steps >= 12500;
                    if (stepsSuccess) stepsGreen++;
                    else stepsRed++;

                    if (entry.workout) {
                        workoutYes++;
                        weeklyWorkouts[weekKey]++;
                    } else {
                        workoutNo++;
                    }

                    // Track for weekly goals
                    weeklyAlcohol[weekKey].push(alcoholSuccess);
                    weeklySteps[weekKey].push(stepsSuccess);
                });

                // Calculate weekly workout success (3+ workouts per week)
                let weeksWithWorkoutGoal = 0;
                let totalWeeks = Object.keys(weeklyWorkouts).length;

                Object.keys(weeklyWorkouts).forEach(weekKey => {
                    const workoutsThisWeek = weeklyWorkouts[weekKey];
                    const alcoholSuccessThisWeek = weeklyAlcohol[weekKey].every(day => day);
                    const stepsSuccessThisWeek = weeklySteps[weekKey].every(day => day);

                    if (workoutsThisWeek >= 3) {
                        weeksWithWorkoutGoal++;
                    }

                    // Count weeks where all three goals were met
                    if (workoutsThisWeek >= 3 && alcoholSuccessThisWeek && stepsSuccessThisWeek) {
                        allThreeGoals++;
                    }
                });

                // Calculate percentages
                const totalDays = yearDates.length;
                const alcoholPercent = totalDays > 0 ? Math.round((alcoholGreen / totalDays) * 100) : 0;
                const stepsPercent = totalDays > 0 ? Math.round((stepsGreen / totalDays) * 100) : 0;
                const workoutPercent = totalWeeks > 0 ? Math.round((weeksWithWorkoutGoal / totalWeeks) * 100) : 0;
                const allThreePercent = totalWeeks > 0 ? Math.round((allThreeGoals / totalWeeks) * 100) : 0;

                let longestStreak = 0;
                let streakCount = 0;
                const sortedDates = Object.keys(state.entries).sort().reverse();

                for (let date of sortedDates) {
                    if (state.entries[date].workout) {
                        streakCount++;
                    } else {
                        if (streakCount > longestStreak) longestStreak = streakCount;
                        streakCount = 0;
                    }
                }
                if (streakCount > longestStreak) longestStreak = streakCount;

                let currentStreak = 0;
                let checkDate = new Date();
                while (state.entries[tracker.formatDate(checkDate)]?.workout) {
                    currentStreak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                }

                // Calculate averages
                const avgAlcohol = totalDays > 0 ? (yearDates.reduce((sum, date) => sum + parseInt(state.entries[date].alcohol || 0), 0) / totalDays).toFixed(1) : 0;
                const avgSteps = totalDays > 0 ? Math.round(yearDates.reduce((sum, date) => sum + parseInt(state.entries[date].steps || 0), 0) / totalDays) : 0;
                const avgWorkouts = totalWeeks > 0 ? (workoutYes / totalWeeks).toFixed(1) : 0;

                // Get current week and last week data
                const today = new Date();
                const currentWeekStart = new Date(today);
                currentWeekStart.setDate(today.getDate() - today.getDay());
                const lastWeekStart = new Date(currentWeekStart);
                lastWeekStart.setDate(currentWeekStart.getDate() - 7);

                const currentWeekKey = tracker.formatDate(currentWeekStart);
                const lastWeekKey = tracker.formatDate(lastWeekStart);

                const currentWeekWorkouts = weeklyWorkouts[currentWeekKey] || 0;
                const lastWeekWorkouts = weeklyWorkouts[lastWeekKey] || 0;

                let weekComparison = '';
                if (lastWeekWorkouts > 0) {
                    if (currentWeekWorkouts > lastWeekWorkouts) {
                        weekComparison = `<span class="text-[#7fd4b8]">üìà +${currentWeekWorkouts - lastWeekWorkouts} vs last week!</span>`;
                    } else if (currentWeekWorkouts < lastWeekWorkouts) {
                        weekComparison = `<span class="text-orange-600">üìâ ${currentWeekWorkouts - lastWeekWorkouts} vs last week</span>`;
                    } else {
                        weekComparison = `<span class="text-[#a8c4e8]">‚û°Ô∏è Same as last week</span>`;
                    }
                }

                return `
                    <div class="p-4 space-y-6">
                        <h2 class="text-2xl font-bold text-center mb-6">${currentYear} Summary</h2>

                        <div class="bg-gradient-to-r from-purple-500 to-pink-500 p-6 rounded-lg shadow-lg text-white">
                            <h3 class="text-2xl font-bold text-center mb-4">üéØ All Goals Achievement</h3>
                            <div class="text-center">
                                <div class="text-6xl font-bold mb-2">${allThreePercent}%</div>
                                <p class="text-lg">Weeks you hit all three goals!</p>
                                <p class="text-sm mt-2 opacity-90">${allThreeGoals} out of ${totalWeeks} weeks</p>
                                <p class="text-xs mt-3 opacity-80">Alcohol 0-2 every day ‚Ä¢ Steps 12,500+ every day ‚Ä¢ Workouts 3+ times</p>
                            </div>
                        </div>

                        <div class="card bg-gradient-to-r from-[#d4e4ff] to-[#e8d4ff]">
                            <h3 class="text-lg font-bold mb-3">üìä Your Averages</h3>
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <div class="text-2xl font-bold text-gray-800">${avgAlcohol}</div>
                                    <div class="text-xs text-gray-600">drinks/day</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-gray-800">${avgSteps.toLocaleString()}</div>
                                    <div class="text-xs text-gray-600">steps/day</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-gray-800">${avgWorkouts}</div>
                                    <div class="text-xs text-gray-600">workouts/week</div>
                                </div>
                            </div>
                            ${weekComparison ? `<div class="mt-3 pt-3 border-t border-gray-300 text-center font-semibold">${weekComparison}</div>` : ''}
                        </div>

                        <div class="bg-[#f8f0ff] p-4 rounded-lg border-2 border-[#e8d4ff]">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-lg">üì¶ Backup Your Data</h3>
                            </div>
                            <p class="text-sm text-gray-700 mb-3">Save your data to prevent loss if you clear browser data or switch devices.</p>
                            <div class="flex gap-2">
                                <button data-action="export" class="flex-1 bg-gradient-to-r from-[#a8e6cf] to-[#7fd4b8] text-white px-4 py-2 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all">
                                    üíæ Export Data
                                </button>
                                <button data-action="import" class="flex-1 bg-gradient-to-r from-[#a8e6cf] to-[#7fd4b8] text-white px-4 py-2 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all">
                                    üì• Import Data
                                </button>
                            </div>
                            <input type="file" id="importFile" accept=".json" style="display: none;" />
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <span class="text-3xl mr-3">üç∑</span>
                                    <h3 class="text-xl font-bold">Alcohol Intake</h3>
                                </div>
                                <div class="text-2xl font-bold text-[#7fd4b8]">${alcoholPercent}%</div>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span>Green (0-2 drinks)</span>
                                    <span class="bg-[#b8f4d4] px-3 py-1 rounded font-bold">${alcoholGreen} days</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>Yellow (3-4 drinks)</span>
                                    <span class="bg-[#fff4b8] px-3 py-1 rounded font-bold">${alcoholYellow} days</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>Red (5+ drinks)</span>
                                    <span class="bg-[#ffb8b8] px-3 py-1 rounded font-bold">${alcoholRed} days</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <span class="text-3xl mr-3">üëü</span>
                                    <h3 class="text-xl font-bold">Step Goals</h3>
                                </div>
                                <div class="text-2xl font-bold text-[#7fd4b8]">${stepsPercent}%</div>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span>Goal Met (12,500+)</span>
                                    <span class="bg-[#b8f4d4] px-3 py-1 rounded font-bold">${stepsGreen} days</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>Below Goal</span>
                                    <span class="bg-[#ffb8b8] px-3 py-1 rounded font-bold">${stepsRed} days</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <span class="text-3xl mr-3">üí™</span>
                                    <h3 class="text-xl font-bold">Workouts</h3>
                                </div>
                                <div class="text-2xl font-bold text-[#7fd4b8]">${workoutPercent}%</div>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">Goal: 3 workouts per week</p>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span>Weeks Goal Met (3+)</span>
                                    <span class="bg-[#b8f4d4] px-3 py-1 rounded font-bold">${weeksWithWorkoutGoal} weeks</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>Total Workouts</span>
                                    <span class="bg-[#d4e4ff] px-3 py-1 rounded font-bold">${workoutYes} days</span>
                                </div>
                                <div class="mt-2 pt-2 border-t space-y-1">
                                    <div>
                                        <span class="font-semibold">Current Streak: </span>
                                        <span class="text-lg font-bold text-[#7fd4b8]">${currentStreak} days üî•</span>
                                    </div>
                                    <div>
                                        <span class="font-semibold">Longest Streak: </span>
                                        <span class="text-lg font-bold text-[#a8c4e8]">${longestStreak} days üèÜ</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center text-sm text-gray-600 mt-6">
                            Total entries this year: ${yearDates.length} days
                        </div>
                    </div>
                `;
            }

            function attachEventListeners() {
                // View navigation
                document.querySelectorAll('[data-view]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        tracker.changeView(e.target.dataset.view);
                    });
                });

                // Input fields - update state on every keystroke but don't re-render
                document.querySelectorAll('[data-field]').forEach(input => {
                    // Update state as user types (keeps data in sync)
                    input.addEventListener('input', (e) => {
                        tracker.state.editEntry[e.target.dataset.field] = e.target.value;
                    });

                    // Update background colors when user finishes (on blur or change)
                    input.addEventListener('blur', (e) => {
                        tracker.updateEntry(e.target.dataset.field, e.target.value);
                        tracker.updateColorBackgrounds();
                    });

                    input.addEventListener('change', (e) => {
                        tracker.updateColorBackgrounds();
                    });
                });

                // Workout buttons
                document.querySelectorAll('[data-workout]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        tracker.updateEntry('workout', e.target.dataset.workout === 'true');
                        tracker.updateColorBackgrounds();
                    });
                });

                // Save button
                const saveBtn = document.querySelector('[data-action="save"]');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        const date = tracker.state.view === 'edit' ? tracker.state.selectedDate : new Date();
                        tracker.saveEntry(date);
                    });
                }

                // Back button
                const backBtn = document.querySelector('[data-action="back"]');
                if (backBtn) {
                    backBtn.addEventListener('click', () => {
                        tracker.setState({ view: 'daily', selectedDate: null });
                    });
                }

                // Export button
                const exportBtn = document.querySelector('[data-action="export"]');
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => {
                        tracker.exportData();
                    });
                }

                // Import button
                const importBtn = document.querySelector('[data-action="import"]');
                const importFile = document.getElementById('importFile');
                if (importBtn && importFile) {
                    importBtn.addEventListener('click', () => {
                        importFile.click();
                    });
                    importFile.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            tracker.importData(e.target.files[0]);
                            e.target.value = ''; // Reset file input
                        }
                    });
                }

                // Delete entry button
                const deleteBtn = document.querySelector('[data-action="delete-entry"]');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', (e) => {
                        const dateKey = e.target.dataset.date;
                        tracker.deleteEntry(dateKey);
                    });
                }

                // Edit date buttons handled by event delegation (see bottom of attachEventListeners)

                // Tooltip for week view
                const tooltip = document.getElementById('tooltip');
                if (tooltip) {
                    document.querySelectorAll('[data-tooltip]').forEach(elem => {
                        elem.addEventListener('mouseenter', (e) => {
                            tooltip.textContent = e.target.dataset.tooltip;
                            tooltip.classList.add('show');
                            const rect = e.target.getBoundingClientRect();
                            tooltip.style.left = rect.left + rect.width / 2 - tooltip.offsetWidth / 2 + 'px';
                            tooltip.style.top = rect.bottom + 8 + 'px';
                        });
                        elem.addEventListener('mouseleave', () => {
                            tooltip.classList.remove('show');
                        });
                        // Touch support for mobile - show tooltip briefly
                        elem.addEventListener('touchstart', (e) => {
                            // Don't prevent default - let the click event fire for navigation
                            tooltip.textContent = e.currentTarget.dataset.tooltip;
                            tooltip.classList.add('show');
                            const rect = e.currentTarget.getBoundingClientRect();
                            tooltip.style.left = rect.left + rect.width / 2 - tooltip.offsetWidth / 2 + 'px';
                            tooltip.style.top = rect.bottom + 8 + 'px';
                            setTimeout(() => tooltip.classList.remove('show'), 1500);
                        });
                    });
                }

                // Week navigation
                const prevWeek = document.querySelector('[data-action="prev-week"]');
                if (prevWeek) {
                    prevWeek.addEventListener('click', () => {
                        const newDate = new Date(tracker.state.currentDate);
                        newDate.setDate(newDate.getDate() - 7);
                        tracker.setState({ currentDate: newDate });
                    });
                }

                const nextWeek = document.querySelector('[data-action="next-week"]');
                if (nextWeek) {
                    nextWeek.addEventListener('click', () => {
                        const newDate = new Date(tracker.state.currentDate);
                        newDate.setDate(newDate.getDate() + 7);
                        tracker.setState({ currentDate: newDate });
                    });
                }

                // Month navigation
                const prevMonth = document.querySelector('[data-action="prev-month"]');
                if (prevMonth) {
                    prevMonth.addEventListener('click', () => {
                        const newDate = new Date(tracker.state.currentDate);
                        newDate.setMonth(newDate.getMonth() - 1);
                        tracker.setState({ currentDate: newDate });
                    });
                }

                const nextMonth = document.querySelector('[data-action="next-month"]');
                if (nextMonth) {
                    nextMonth.addEventListener('click', () => {
                        const newDate = new Date(tracker.state.currentDate);
                        newDate.setMonth(newDate.getMonth() + 1);
                        tracker.setState({ currentDate: newDate });
                    });
                }
            }

            tracker.subscribe(render);
            render();

            // Set up event delegation for edit date buttons (only once)
            container.addEventListener('click', (e) => {
                const editDateBtn = e.target.closest('[data-edit-date]');
                if (editDateBtn) {
                    const dateStr = editDateBtn.dataset.editDate;
                    const date = new Date(dateStr + 'T12:00:00');
                    tracker.editDate(date);
                }
            });
        }

        // Initialize app
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', App);
        } else {
            App();
        }
    </script>
</body>
</html>
